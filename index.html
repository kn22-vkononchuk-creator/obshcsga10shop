<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ObshchagaSHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent-blue': '#3b82f6',
                        'header-dark': '#1f2937',
                        'success-green': '#059669',
                        'light-bg': '#f9fafb',
                        'border-light': '#e5e7eb',
                        'warning-orange': '#f59e0b',
                        'danger-red': '#ef4444',
                        'info-blue': '#60a5fa', /* New color for info/new status */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'custom-light': '0 10px 30px rgba(0, 0, 0, 0.08)',
                        'custom-medium': '0 15px 40px rgba(0, 0, 0, 0.12)',
                    }
                }
            }
        }
    </script>
    <style>
        /* БАЗОВІ СТИЛІ ТА НАЛАШТУВАННЯ TAILWIND */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.6;
        }

        header {
            background-color: #1f2937;
            color: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            z-index: 50;
            position: sticky;
            top: 0;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: -0.03em;
            color: #fff;
            cursor: pointer;
            /* Додано для клікабельності логотипу */
        }

        nav ul li a {
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 8px;
            padding: 0.6rem 1rem;
        }

        nav ul li a:hover,
        nav ul li a.active-link {
            background-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .container {
            max-width: 1300px;
            margin: 2.5rem auto;
            padding: 0 1.5rem;
            /* MOBILE ADAPTATION: Зменшуємо відступи на мобільних */
            padding: 0 1rem;
        }

        /* MOBILE ADAPTATION: Зменшуємо верхній відступ контейнера на мобільних */
        @media (max-width: 640px) {
            .container {
                margin-top: 1.5rem;
            }
        }


        .page {
            display: none;
            background-color: white;
            border-radius: 18px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.07);
            padding: 3rem;
            margin-top: 2rem;
            /* MOBILE ADAPTATION: Зменшуємо padding на мобільних */
            padding: 1.5rem;
        }

        /* MOBILE ADAPTATION: Зменшуємо margin-top сторінки на мобільних */
        @media (max-width: 640px) {
            .page {
                margin-top: 1.5rem;
                border-radius: 12px;
                /* Трохи менший радіус */
            }
        }


        .page.active {
            display: block;
        }

        /* КАРТКА ТОВАРУ */
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
            min-height: 420px;
            transition: min-height 0.3s ease, transform 0.3s ease-out, box-shadow 0.3s ease-out;
            overflow: hidden;
        }

        .product-card:hover {
            min-height: 520px;
            box-shadow: 0 25px 55px rgba(0, 0, 0, 0.15);
            transform: translateY(-8px);
        }

        /* MOBILE ADAPTATION: Зменшуємо min-height на мобільних */
        @media (max-width: 640px) {
            .product-card {
                min-height: 380px;
                padding: 1rem;
            }

            .product-card:hover {
                min-height: 450px;
                /* Зменшуємо висоту при ховері на мобільних */
            }
        }


        /* Опис товару, що виїжджає ЗНИЗУ */
        .product-description-wrapper {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding-top 0.3s ease;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #4b5563;
            margin-top: 0;
            padding-top: 0;
            text-align: left;
            width: 100%;
        }

        .product-card:hover .product-description-wrapper {
            max-height: 150px;
            padding-top: 1rem;
        }

        /* MOBILE ADAPTATION: Зменшуємо max-height опису на мобільних */
        @media (max-width: 640px) {
            .product-card:hover .product-description-wrapper {
                max-height: 100px;
                /* Менше місця для опису */
                font-size: 0.85rem;
            }
        }


        /* Стилі для ціни зі знижкою */
        .original-price {
            text-decoration: line-through;
            color: #6b7280;
            font-size: 0.9em;
            margin-right: 0.5rem;
        }

        .discount-badge {
            background-color: #ef4444;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        /* КОРЗИНА */
        #cart-count {
            position: absolute;
            top: -8px;
            right: -10px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 4px 9px;
            font-size: 0.85rem;
            font-weight: 700;
            opacity: 0;
            transform: scale(0);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        #cart-count.active {
            opacity: 1;
            transform: scale(1);
        }

        @keyframes bump {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }
        }

        .cart-bump {
            animation: bump 0.3s ease-in-out;
        }

        /* СТИЛЬ КНОПОК - Сучасний 3D */
        .primary-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.85rem 1.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            font-weight: 700;
            box-shadow: 0 6px 0 #2563eb;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-btn:hover {
            background-color: #2563eb;
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #1d4ed8;
        }

        .primary-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #1d4ed8;
        }

        /* DIALOG BOX */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        .dialog-show {
            display: flex;
            opacity: 1;
        }

        .dialog-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.25);
            transform: scale(0.85);
            transition: transform 0.3s ease-out;
            /* MOBILE ADAPTATION: Зменшуємо padding та радіус на мобільних */
            padding: 1.5rem;
            border-radius: 12px;
        }

        /* MOBILE ADAPTATION: Збільшуємо ширину модалки на дуже малих екранах */
        @media (max-width: 480px) {
            .dialog-content {
                width: 95%;
            }
        }


        .dialog-show .dialog-content {
            transform: scale(1);
        }

        /* SPINNER */
        #api-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Додаткові стилі для адмін-панелі та наявності */
        .product-availability {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .product-availability.in-stock {
            background-color: #d1fae5;
            color: #065f46;
        }

        .product-availability.out-of-stock {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .admin-product-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .admin-product-item:last-child {
            margin-bottom: 0;
        }

        .admin-product-item .product-details {
            flex-grow: 1;
            margin-right: 1rem;
            min-width: 150px;
            /* MOBILE ADAPTATION: Зменшуємо min-width на мобільних */
            min-width: 120px;
        }

        .admin-product-item .product-details .name {
            font-weight: 600;
            color: #1f2937;
        }

        .admin-product-item .product-details .price {
            font-size: 0.9rem;
            color: #059669;
        }

        .admin-product-item .product-details .id {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .admin-product-item .controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
            /* MOBILE ADAPTATION: Змінюємо вирівнювання на мобільних */
            justify-content: center;
            margin-top: 0.5rem;
        }

        /* MOBILE ADAPTATION: Зменшуємо відступи між елементами керування на мобільних */
        @media (max-width: 640px) {
            .admin-product-item .controls {
                gap: 0.5rem;
            }
        }


        .admin-product-item .controls input[type="number"] {
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            font-size: 0.9rem;
            width: 70px;
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        /* MOBILE ADAPTATION: Зменшуємо ширину інпуту на мобільних */
        @media (max-width: 640px) {
            .admin-product-item .controls input[type="number"] {
                width: 60px;
                padding: 0.3rem 0.5rem;
            }
        }


        .admin-product-item .controls input[type="number"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        .admin-product-item .controls .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 0 #dc2626;
        }

        /* MOBILE ADAPTATION: Зменшуємо padding кнопок на мобільних */
        @media (max-width: 640px) {

            .admin-product-item .controls .delete-btn,
            .admin-product-item .controls .notify-btn,
            .admin-product-item .controls .edit-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
        }


        .admin-product-item .controls .delete-btn:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 0 #b91c1c;
        }

        .admin-product-item .controls .delete-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #b91c1c;
        }

        /* Стилі для кнопки сповіщення */
        .notify-btn {
            background-color: #10b981;
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 0 #059669;
        }

        .notify-btn:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 0 #047857;
        }

        .notify-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #047857;
        }

        /* Стилі для кнопки редагування */
        .edit-btn {
            background-color: #f59e0b;
            /* Warning Orange */
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 0 #d97706;
        }

        .edit-btn:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 0 #b45309;
        }

        .edit-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #b45309;
        }

        /* Стилі для кнопки власного сповіщення (загального) */
        .general-notify-btn {
            background-color: #6366f1;
            /* Indigo */
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 6px 0 #4338ca;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .general-notify-btn:hover {
            background-color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #3730a3;
        }

        .general-notify-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #3730a3;
        }

        /* Styles for customer list */
        .customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .customer-item:last-child {
            margin-bottom: 0;
        }

        .customer-item .customer-details {
            flex-grow: 1;
        }

        .customer-item .customer-details .username {
            font-weight: 600;
            color: #1f2937;
        }

        .customer-item .customer-details .chat-id {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Styles for order list */
        .order-item {
            background-color: #fff;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-item .order-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .order-item .order-id {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .order-item .order-status {
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
        }

        .order-item .order-status.New {
            background-color: #e0f2fe;
            /* light blue */
            color: #0284c7;
            /* sky blue */
        }

        .order-item .order-status.Confirmed {
            background-color: #d1fae5;
            /* light green */
            color: #065f46;
            /* dark green */
        }

        .order-item .order-status.Cancelled {
            background-color: #fee2e2;
            /* light red */
            color: #991b1b;
            /* dark red */
        }

        .order-item .order-details p {
            font-size: 0.9rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        .order-item .order-items-summary {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #e5e7eb;
        }

        .order-item .order-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        .order-item .order-actions .primary-btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            box-shadow: 0 3px 0;
        }

        .order-item .order-actions .primary-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 0;
        }

        .order-item .order-actions .primary-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0;
        }
    </style>
</head>

<body class="bg-light-bg font-sans">

    <header>
        <div class="container flex justify-between items-center py-4">
            <div class="logo" id="logo-link">🌟 ObshchagaSHOP</div>
            <!-- MOBILE ADAPTATION: Зменшуємо відступи між елементами навігації на мобільних -->
            <nav>
                <ul class="flex space-x-2 sm:space-x-4">
                    <!-- Кнопка "Товари" видалена -->
                    <li class="relative" id="cart-nav-item">
                        <a href="#cart" class="nav-link p-2 sm:p-3" data-page="cart" aria-label="Кошик">
                            <!-- Іконка кошика -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </a>
                        <span id="cart-count">0</span>
                    </li>
                    <!-- Кнопка "Адмін" видалена з навігації -->
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- СТОРІНКА ТОВАРІВ -->
        <div id="products-page" class="page active">
            <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка на мобільних -->
            <h1 class="text-2xl sm:text-3xl font-extrabold text-header-dark mb-6 sm:mb-8 border-b pb-2 sm:pb-3">Каталог
                товарів</h1>

            <!-- Поле пошуку -->
            <div class="mb-6">
                <label for="search-input" class="sr-only">Пошук товарів</label>
                <input type="text" id="search-input" placeholder="Пошук товарів за назвою або описом..."
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue shadow-sm">
            </div>

            <!-- Фільтри та сортування -->
            <!-- MOBILE ADAPTATION: Фільтри тепер завжди в стовпчик на мобільних -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="category-filter" class="font-medium text-gray-700 whitespace-nowrap">Категорія:</label>
                    <select id="category-filter" class="border border-gray-300 rounded-lg p-2 w-full">
                        <option value="">Всі категорії</option>
                        <!-- Категорії будуть завантажені сюди JS -->
                    </select>
                </div>

                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="sort-filter" class="font-medium text-gray-700 whitespace-nowrap">Сортувати:</label>
                    <select id="sort-filter" class="border border-gray-300 rounded-lg p-2 w-full">
                        <option value="date_desc">Дата додавання: нові</option>
                        <option value="date_asc">Дата додавання: старі</option>
                        <option value="price_desc">Ціна: від дорожчого до дешевшого</option>
                        <option value="price_asc">Ціна: від дешевшого до дорожчого</option>
                    </select>
                </div>
            </div>

            <!-- MOBILE ADAPTATION: Сітка товарів - 1 колонка на мобільних, 2 на sm, 3 на lg, 4 на xl -->
            <div id="products-container"
                class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-8">
                <!-- Товари будуть завантажені сюди -->
            </div>
            <div id="loading" class="text-center text-xl text-gray-500 mt-12">Завантаження товарів...</div>
            <div id="error-message" class="text-center text-xl text-red-500 mt-12 hidden p-4 bg-red-100 rounded-xl">
            </div>
        </div>

        <!-- СТОРІНКА КОШИКА -->
        <div id="cart-page" class="page">
            <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка на мобільних -->
            <h1 class="text-2xl sm:text-3xl font-extrabold text-header-dark mb-6 sm:mb-8 border-b pb-2 sm:pb-3">Ваш
                кошик</h1>

            <div id="cart-items" class="space-y-4">
                <!-- Елементи кошика -->
            </div>

            <!-- MOBILE ADAPTATION: Сума кошика та кнопка оформлення - адаптивні -->
            <div
                class="flex flex-col sm:flex-row justify-end items-end sm:items-center mt-8 pt-4 border-t border-gray-200">
                <div
                    class="text-xl sm:text-2xl font-bold text-header-dark mr-0 sm:mr-6 mb-4 sm:mb-0 w-full sm:w-auto text-right">
                    Разом: <span id="cart-total" class="text-success-green">0.00</span> грн
                </div>
            </div>

            <!-- Форма Інформації про Клієнта -->
            <div class="mt-8 p-4 sm:p-6 bg-light-bg rounded-xl shadow-inner border border-border-light">
                <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка форми на мобільних -->
                <h2 class="text-xl sm:text-2xl font-bold text-header-dark mb-4 sm:mb-6">Дані для оформлення замовлення
                </h2>
                <form id="customer-info-form" class="space-y-4">
                    <div>
                        <label for="customer-name" class="block mb-1 font-medium text-gray-700">Ваше ім'я</label>
                        <input type="text" id="customer-name"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            placeholder="Іван Іванов" required>
                    </div>
                    <div>
                        <label for="customer-telegram" class="block mb-1 font-medium text-gray-700">Ваш нік у Telegram (без @) <span class="text-red-500">*</span></label>
                        <input type="text" id="customer-telegram"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            placeholder="username" required>
                        <p class="text-sm text-gray-500 mt-1">Обов'язково зареєструйтесь у нашому Telegram боті (<a
                                href="https://t.me/obschaga10shop_bot" target="_blank"
                                class="text-accent-blue hover:underline">@obschaga10shop_bot</a>) командою /start, щоб
                            отримувати сповіщення про замовлення.</p>
                    </div>
                    <div>
                        <label for="customer-phone" class="block mb-1 font-medium text-gray-700">Номер телефону</label>
                        <input type="tel" id="customer-phone"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            placeholder="+380XXXXXXXXX" required>
                    </div>
                    <div>
                        <label for="customer-address" class="block mb-1 font-medium text-gray-700">Кімната доставки</label>
                        <input type="text" id="customer-address"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            placeholder="666">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="needs-delivery"
                            class="h-5 w-5 text-accent-blue rounded focus:ring-accent-blue">
                        <label for="needs-delivery" class="ml-2 block text-gray-900">Потрібна доставка (+50 грн)</label>
                    </div>
                    <button type="submit" id="checkout-btn"
                        class="primary-btn w-full text-base py-3 px-8 text-lg w-full transition duration-300"
                        disabled>
                        Оформити замовлення
                    </button>
                </form>
            </div>
        </div>

        <!-- СТОРІНКА АДМІН-ПАНЕЛІ -->
        <div id="admin-page" class="page">
            <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка на мобільних -->
            <h1 class="text-2xl sm:text-3xl font-extrabold text-header-dark mb-6 sm:mb-8 border-b pb-2 sm:pb-3">
                Адмін-панель</h1>

            <div id="admin-login-area">
                <!-- MOBILE ADAPTATION: Зменшуємо padding та розмір заголовка форми на мобільних -->
                <form id="admin-login-form"
                    class="space-y-6 p-6 sm:p-8 border border-border-light rounded-xl max-w-sm mx-auto shadow-lg bg-white">
                    <h2 class="text-xl sm:text-2xl font-bold text-center text-header-dark">Вхід Адміністратора</h2>
                    <div>
                        <label for="admin-username" class="block mb-1 font-medium text-gray-700">Ім'я користувача</label>
                        <input type="text" id="admin-username"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            required>
                    </div>
                    <div>
                        <label for="admin-password" class="block mb-1 font-medium text-gray-700">Пароль</label>
                        <input type="password" id="admin-password"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            required>
                    </div>
                    <button type="submit" class="primary-btn w-full">Увійти</button>
                    <p id="login-error" class="text-red-500 text-sm hidden text-center"></p>
                </form>
            </div>

            <div id="admin-content" class="hidden">
                <!-- Навігація адмін-панелі -->
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button type="button" data-admin-page="products-management" class="admin-nav-btn primary-btn bg-accent-blue hover:bg-blue-600 shadow-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7 3a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1V4a1 1 0 00-1-1H7zM7 7a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1H7zM7 11a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1v-1a1 1 0 00-1-1H7zM7 15a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1v-1a1 1 0 00-1-1H7zM11 3a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1V4a1 1 0 00-1-1h-2zM11 7a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2zM11 11a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1v-1a1 1 0 00-1-1h-2zM11 15a1 1 0 00-1 1v1a1 1 0 001 1h2a1 1 0 001-1v-1a1 1 0 00-1-1h-2z" />
                        </svg>
                        Товари
                    </button>
                    <button type="button" data-admin-page="orders-management" class="admin-nav-btn primary-btn bg-indigo-600 hover:bg-indigo-700 shadow-indigo-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H5a1 1 0 01-1-1zm1-8a1 1 0 00-1 1v1h12V7a1 1 0 00-1-1H5z" clip-rule="evenodd" />
                        </svg>
                        Замовлення
                    </button>
                    <button type="button" data-admin-page="users-management" class="admin-nav-btn primary-btn bg-green-600 hover:bg-green-700 shadow-green-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                        Користувачі
                    </button>
                    <button type="button" data-admin-page="notifications-management" class="admin-nav-btn primary-btn bg-purple-600 hover:bg-purple-700 shadow-purple-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 012.707 13H17.293a1 1 0 01.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 16a2 2 0 01-2-2h4a2 2 0 01-2 2z" />
                        </svg>
                        Сповіщення
                    </button>
                </div>

                <!-- Контент для управління товарами -->
                <div id="products-management-section" class="admin-section">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                        <!-- ФОРМА ДОДАВАННЯ ТОВАРУ -->
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Додати новий товар</h2>
                            <form id="add-product-form"
                                class="space-y-4 p-4 sm:p-6 bg-light-bg rounded-xl shadow-inner border border-border-light"
                                enctype="multipart/form-data">
                                <input type="text" id="product-name" placeholder="Назва товару"
                                    class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                                    required>
                                <textarea id="product-description" placeholder="Опис товару (необов'язково)"
                                    class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                                    rows="3"></textarea>
                                <input type="number" id="product-price" placeholder="Ціна (грн)" step="0.01" min="0.01"
                                    class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                                    required>

                                <!-- Поля для зображення -->
                                <div>
                                    <label for="product-image-file" class="block mb-1 font-medium text-gray-700">Завантажити зображення (файл)</label>
                                    <input type="file" id="product-image-file" accept="image/*"
                                        class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                                    <p class="text-sm text-gray-500 mt-1">Або</p>
                                </div>
                                <div>
                                    <label for="product-image-url" class="block mb-1 font-medium text-gray-700">Вставити URL зображення</label>
                                    <input type="url" id="product-image-url" placeholder="https://example.com/image.jpg"
                                        class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                                    <p class="text-sm text-gray-500 mt-1">Якщо заповнені обидва поля, пріоритет буде у
                                        завантаженого файлу.</p>
                                </div>

                                <input type="number" id="product-stock" placeholder="Кількість в наявності" min="0" value="1"
                                    class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                                    required>

                                <!-- Поля для знижок -->
                                <div
                                    class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                    <label for="product-discount" class="font-medium text-gray-700">Знижка (%)</label>
                                    <input type="number" id="product-discount" value="0" min="0" max="100"
                                        class="w-full sm:w-24 p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="product-on-sale"
                                            class="h-5 w-5 text-accent-blue rounded focus:ring-accent-blue">
                                        <label for="product-on-sale" class="ml-2 text-gray-900">Акція</label>
                                    </div>
                                </div>

                                <!-- Вибір категорії для товару -->
                                <div>
                                    <label for="product-category-select" class="block mb-1 font-medium text-gray-700">Категорія товару</label>
                                    <select id="product-category-select" class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                                        <option value="">Без категорії</option>
                                        <!-- Категорії будуть завантажені сюди JS -->
                                    </select>
                                </div>

                                <button type="submit"
                                    class="primary-btn bg-success-green hover:bg-green-600 shadow-green-700 flex items-center justify-center w-full">
                                    <div id="add-product-spinner"></div> Додати до MySQL
                                </button>
                                <p id="add-product-error" class="text-red-500 text-sm hidden"></p>
                            </form>
                        </div>

                        <!-- Керування категоріями -->
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Керування категоріями</h2>
                            <form id="add-category-form"
                                class="space-y-3 p-4 bg-light-bg rounded-xl shadow-inner border border-border-light mb-6">
                                <input type="text" id="category-name-input" placeholder="Назва нової категорії"
                                    class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                                    required>
                                <button type="submit" class="primary-btn w-full bg-purple-600 hover:bg-purple-700 shadow-purple-800">
                                    Додати категорію
                                </button>
                                <p id="add-category-error" class="text-red-500 text-sm hidden"></p>
                            </form>
                            <div id="admin-categories-list"
                                class="space-y-2 p-4 bg-white rounded-xl h-40 sm:h-48 overflow-y-auto border border-border-light shadow-md">
                                <!-- Список категорій для адміна -->
                                <p class="text-gray-500">Категорії будуть завантажені тут.</p>
                            </div>
                        </div>

                        <!-- НОВИЙ БЛОК: ІМПОРТ ТОВАРІВ З CSV -->
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Імпорт товарів з CSV</h2>
                            <div class="p-4 sm:p-6 bg-light-bg rounded-xl shadow-inner border border-border-light">
                                <p class="text-gray-700 mb-4">Завантажте CSV-файл для масового додавання/оновлення
                                    товарів.
                                </p>
                                <p class="text-sm text-gray-500 mb-4">
                                    Формат CSV: `Назва продукту,ціна за штуку,кількість,акція якшо є (1/0),відсоток
                                    знижки,опис,URL зображення`.
                                    <br>
                                    * `акція якшо є (1/0)`: `1` для акції, `0` якщо немає.
                                    <br>
                                    * `відсоток знижки`: число від `0` до `100`.
                                    <br>
                                    * `URL зображення`: пряме посилання на зображення (необов'язково).
                                    <br>
                                    * Якщо товар з такою назвою вже існує, він буде оновлений.
                                </p>
                                <form id="import-csv-form" class="space-y-4" enctype="multipart/form-data">
                                    <div>
                                        <label for="csv-file-input" class="block mb-1 font-medium text-gray-700">Виберіть CSV-файл</label>
                                        <input type="file" id="csv-file-input" accept=".csv"
                                            class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                                            required>
                                    </div>
                                    <button type="submit" id="import-csv-btn"
                                        class="primary-btn bg-purple-600 hover:bg-purple-700 shadow-purple-800 flex items-center justify-center w-full">
                                        <div id="import-csv-spinner"></div> Імпортувати CSV
                                    </button>
                                    <p id="import-csv-error" class="text-red-500 text-sm hidden"></p>
                                    <p id="import-csv-success" class="text-success-green text-sm hidden"></p>
                                </form>
                                <button type="button" id="export-csv-sample-btn" class="primary-btn bg-gray-600 hover:bg-gray-700 shadow-gray-800 flex items-center justify-center w-full mt-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                    Експортувати зразок CSV
                                </button>
                            </div>
                        </div>
                        <!-- КІНЕЦЬ НОВОГО БЛОКУ -->

                        <!-- СПИСОК ПОТОЧНИХ ТОВАРІВ -->
                        <div class="lg:col-span-2">
                            <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Поточні товари (Керування)
                            </h2>
                            <div id="admin-products-list"
                                class="space-y-3 p-4 bg-white rounded-xl h-80 sm:h-96 overflow-y-auto border border-border-light shadow-md">
                                <!-- Список товарів для адміна -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Контент для управління замовленнями -->
                <div id="orders-management-section" class="admin-section hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Керування замовленнями</h2>
                    <div class="mb-4 flex flex-wrap gap-4 items-center">
                        <label for="order-status-filter" class="font-medium text-gray-700">Фільтр за статусом:</label>
                        <select id="order-status-filter" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Всі статуси</option>
                            <option value="New">Нові</option>
                            <option value="Confirmed">Підтверджені</option>
                            <option value="Cancelled">Скасовані</option>
                        </select>
                        <button type="button" id="refresh-orders-btn" class="primary-btn bg-indigo-600 hover:bg-indigo-700 shadow-indigo-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.008a.5.5 0 01.416.223l.47 1.024a.5.5 0 01-.416.777H4a.5.5 0 01-.416-.777l.47-1.024a.5.5 0 01.416-.223zM16 17a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 01-1 1z" clip-rule="evenodd" />
                            </svg>
                            Оновити замовлення
                        </button>
                    </div>
                    <div id="admin-orders-list"
                        class="space-y-3 p-4 bg-white rounded-xl h-96 overflow-y-auto border border-border-light shadow-md">
                        <p class="text-gray-500">Замовлення будуть завантажені тут.</p>
                    </div>
                </div>

                <!-- Контент для управління користувачами -->
                <div id="users-management-section" class="admin-section hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Зареєстровані користувачі Telegram
                    </h2>
                    <div id="admin-customers-list"
                        class="space-y-3 p-4 bg-white rounded-xl h-80 sm:h-96 overflow-y-auto border border-border-light shadow-md">
                        <p class="text-gray-500">Користувачі будуть завантажені тут.</p>
                    </div>
                    <button type="button" id="refresh-customers-btn" class="primary-btn bg-indigo-600 hover:bg-indigo-700 shadow-indigo-800 flex items-center justify-center w-full mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.008a.5.5 0 01.416.223l.47 1.024a.5.5 0 01-.416.777H4a.5.5 0 01-.416-.777l.47-1.024a.5.5 0 01.416-.223zM16 17a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 01-1 1z" clip-rule="evenodd" />
                        </svg>
                        Оновити список користувачів
                    </button>
                </div>

                <!-- Контент для управління сповіщеннями -->
                <div id="notifications-management-section" class="admin-section hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-accent-blue mb-4">Відправити загальне сповіщення</h2>
                    <div class="p-4 sm:p-6 bg-light-bg rounded-xl shadow-inner border border-border-light">
                        <p class="text-gray-700 mb-4">Надішліть повідомлення всім підписникам Telegram.</p>
                        <button type="button" id="open-general-notify-modal-btn" class="general-notify-btn w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17v2m-2-2H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Створити сповіщення
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- КОРИСТУВАЦЬКЕ ДІАЛОГОВЕ ВІКНО (Заміна alert/confirm) -->
    <div id="dialog-box" class="dialog-overlay">
        <div class="dialog-content">
            <p id="dialog-message" class="text-xl font-semibold text-gray-800 mb-8"></p>
            <div class="dialog-actions flex justify-center space-x-4">
                <button id="dialog-alert-btn"
                    class="bg-accent-blue text-white px-6 py-2 rounded-lg hover:bg-blue-600 font-medium transition primary-btn">ОК</button>
                <button id="dialog-confirm-btn"
                    class="bg-success-green text-white px-6 py-2 rounded-lg hover:bg-green-600 font-medium transition hidden primary-btn">Підтвердити</button>
                <button id="dialog-cancel-btn"
                    class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500 font-medium transition hidden primary-btn shadow-gray-600">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНЕ ВІКНО РЕДАГУВАННЯ ТОВАРУ -->
    <div id="edit-product-modal" class="dialog-overlay">
        <!-- MOBILE ADAPTATION: Зменшуємо max-width та padding на мобільних -->
        <div class="dialog-content !max-w-md sm:!max-w-2xl !p-4 sm:!p-6">
            <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка на мобільних -->
            <h2 class="text-xl sm:text-2xl font-bold text-header-dark mb-4 sm:mb-6 text-left">Редагувати товар</h2>
            <form id="edit-product-form" class="space-y-4" enctype="multipart/form-data">
                <input type="hidden" id="edit-product-id">
                <input type="hidden" id="edit-image-url-changed" value="false">
                <div>
                    <label for="edit-product-name" class="block mb-1 font-medium text-gray-700">Назва товару</label>
                    <input type="text" id="edit-product-name"
                        class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                        required>
                </div>
                <div>
                    <label for="edit-product-description" class="block mb-1 font-medium text-gray-700">Опис товару</label>
                    <textarea id="edit-product-description"
                        class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                        rows="4"></textarea>
                </div>
                <!-- MOBILE ADAPTATION: Ціна та наявність - в стовпчик на мобільних -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-product-price" class="block mb-1 font-medium text-gray-700">Ціна (грн)</label>
                        <input type="number" id="edit-product-price" step="0.01" min="0.01"
                            class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            required>
                    </div>
                    <div>
                        <label for="edit-product-stock" class="block mb-1 font-medium text-gray-700">Кількість в наявності</label>
                        <input type="number" id="edit-product-stock" min="0"
                            class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue"
                            required>
                    </div>
                </div>

                <!-- Поля для зображення -->
                <div>
                    <label class="block mb-1 font-medium text-gray-700">Поточне зображення</label>
                    <img id="edit-current-image-preview" src="" alt="Поточне зображення" class="w-24 h-24 object-cover rounded-lg mb-2 border border-gray-200" loading="lazy">
                    <label for="edit-product-image-file" class="block mb-1 font-medium text-gray-700">Завантажити нове зображення (файл)</label>
                    <input type="file" id="edit-product-image-file" accept="image/*"
                        class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                    <p class="text-sm text-gray-500 mt-1">Або</p>
                </div>
                <div>
                    <label for="edit-product-image-url" class="block mb-1 font-medium text-gray-700">Вставити URL зображення</label>
                    <input type="url" id="edit-product-image-url" placeholder="https://example.com/image.jpg"
                        class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                    <p class="text-sm text-gray-500 mt-1">Якщо заповнені обидва поля, пріоритет буде у завантаженого
                        файлу.</p>
                </div>

                <!-- Поля для знижок -->
                <!-- MOBILE ADAPTATION: Знижки - адаптивні -->
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="edit-product-discount" class="font-medium text-gray-700">Знижка (%)</label>
                    <input type="number" id="edit-product-discount" value="0" min="0" max="100"
                        class="w-full sm:w-24 p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                    <div class="flex items-center">
                        <input type="checkbox" id="edit-product-on-sale"
                            class="h-5 w-5 text-accent-blue rounded focus:ring-accent-blue">
                        <label for="edit-product-on-sale" class="ml-2 text-gray-900">Акція</label>
                    </div>
                </div>

                <!-- Вибір категорії для товару -->
                <div>
                    <label for="edit-product-category-select" class="block mb-1 font-medium text-gray-700">Категорія товару</label>
                    <select id="edit-product-category-select" class="w-full p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                        <option value="">Без категорії</option>
                        <!-- Категорії будуть завантажені сюди JS -->
                    </select>
                </div>

                <!-- MOBILE ADAPTATION: Кнопки - адаптивні -->
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                    <button type="button" id="cancel-edit-btn"
                        class="primary-btn bg-gray-400 hover:bg-gray-500 shadow-gray-600 w-full sm:w-auto">Скасувати</button>
                    <button type="submit" id="save-edit-btn"
                        class="primary-btn bg-accent-blue hover:bg-blue-600 shadow-blue-700 flex items-center justify-center w-full sm:w-auto">
                        <div id="edit-product-spinner"></div> Зберегти зміни
                    </button>
                </div>
                <p id="edit-product-error" class="text-red-500 text-sm hidden text-center"></p>
            </form>
        </div>
    </div>

    <!-- Модальне вікно редагування категорії -->
    <div id="edit-category-modal" class="dialog-overlay">
        <!-- MOBILE ADAPTATION: Зменшуємо max-width та padding на мобільних -->
        <div class="dialog-content !max-w-xs sm:!max-w-md w-full">
            <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка на мобільних -->
            <h2 class="text-xl sm:text-2xl font-bold mb-4">Редагувати категорію</h2>
            <form id="edit-category-form" class="space-y-4">
                <input type="hidden" id="edit-category-id">
                <input type="text" id="edit-category-name" placeholder="Назва категорії"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue" required>
                <!-- MOBILE ADAPTATION: Кнопки - адаптивні -->
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                    <button type="button" id="cancel-edit-category-btn"
                        class="primary-btn bg-gray-400 hover:bg-gray-500 shadow-gray-600 w-full sm:w-auto">Скасувати</button>
                    <button type="submit" id="save-edit-category-btn"
                        class="primary-btn bg-accent-blue hover:bg-blue-600 shadow-blue-700 w-full sm:w-auto">Зберегти</button>
                </div>
                <p id="edit-category-error" class="text-red-500 text-sm hidden text-center"></p>
            </form>
        </div>
    </div>

    <!-- Модальне вікно власного сповіщення (тепер для загальних повідомлень) -->
    <div id="custom-notify-modal" class="dialog-overlay">
        <!-- MOBILE ADAPTATION: Зменшуємо max-width та padding на мобільних -->
        <div class="dialog-content !max-w-md sm:!max-w-lg w-full">
            <!-- MOBILE ADAPTATION: Зменшуємо розмір заголовка на мобільних -->
            <h2 class="text-xl sm:text-2xl font-bold mb-4">Створити загальне сповіщення</h2>
            <form id="custom-notify-form" class="space-y-4">
                <textarea id="notify-message-text" rows="5" placeholder="Введіть текст повідомлення..."
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue" required></textarea>
                <div>
                    <label for="notify-image-file" class="block mb-1 font-medium text-gray-700">Додати фото (необов’язково)</label>
                    <input type="file" id="notify-image-file" accept="image/*"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-accent-blue focus:border-accent-blue">
                </div>
                <!-- MOBILE ADAPTATION: Кнопки - адаптивні -->
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                    <button type="button" id="notify-cancel-btn" class="primary-btn bg-gray-400 hover:bg-gray-500 shadow-gray-600 w-full sm:w-auto">Скасувати</button>
                    <button type="submit" id="notify-send-btn" class="primary-btn bg-success-green hover:bg-green-600 shadow-green-700 flex items-center justify-center w-full sm:w-auto">
                        Відправити
                    </button>
                </div>
                <p id="notify-error" class="text-red-500 text-sm hidden text-center"></p>
            </form>
        </div>
    </div>

    <!-- NEW: Модальне вікно для першого відвідування -->
    <div id="first-visit-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <p class="text-xl font-semibold text-gray-800 mb-8">
                Привіт! 👋 Ласкаво просимо до ObshchagaSHOP!
                <br><br>
                Щоб мати можливість оформлювати замовлення та отримувати сповіщення про їх статус, будь ласка,
                зайдіть у наш Telegram бот:
                <br><br>
                <a href="https://t.me/obschaga10shop_bot" target="_blank"
                    class="text-accent-blue hover:underline font-bold text-2xl">
                    @obschaga10shop_bot
                </a>
                <br><br>
                та відправте йому команду `/start`.
            </p>
            <div class="dialog-actions flex justify-center">
                <button id="first-visit-ok-btn" class="primary-btn">Зрозуміло</button>
            </div>
        </div>
    </div>


    <script>
        // *** НАЛАШТУВАННЯ API ***
        const API_BASE_URL = 'products_api.php';
        const UPLOAD_DIR = 'uploads/';
        const WEBSITE_BASE_URL = 'https://www.obshchaga10shop.website/'; // <--- ВАШ РЕАЛЬНИЙ ДОМЕН МАГАЗИНУ!
        const ADMIN_SECRET_PATH = '#admin-panel-secret'; // Секретний шлях для адмін-панелі

        // --- ГЛОБАЛЬНІ ЗМІННІ ---
        let products = [];
        let categories = [];
        let customers = []; // New global variable for customers
        let orders = []; // NEW: Global variable for orders
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let isAdminLoggedIn = false;
        const DELIVERY_COST = 50.00;

        // --- DOM ЕЛЕМЕНТИ ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const productsContainer = document.getElementById('products-container');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const adminProductsList = document.getElementById('admin-products-list');
        const cartCountElement = document.getElementById('cart-count');
        const checkoutBtn = document.getElementById('checkout-btn');
        const addProductSpinner = document.getElementById('add-product-spinner');
        const cartTotalElement = document.getElementById('cart-total');
        const needsDeliveryCheckbox = document.getElementById('needs-delivery');
        const customerInfoForm = document.getElementById('customer-info-form');
        const logoLink = document.getElementById('logo-link'); // Додано посилання на логотип
        const searchInput = document.getElementById('search-input'); // Додано поле пошуку

        // Елементи Діалогу
        const dialogBox = document.getElementById('dialog-box');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogAlertBtn = document.getElementById('dialog-alert-btn');
        const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
        const dialogCancelBtn = document.getElementById('dialog-cancel-btn');
        let dialogResolve = null;

        // Елементи модального вікна редагування товару
        const editProductModal = document.getElementById('edit-product-modal');
        const editProductForm = document.getElementById('edit-product-form');
        const editProductId = document.getElementById('edit-product-id');
        const editProductName = document.getElementById('edit-product-name');
        const editProductDescription = document.getElementById('edit-product-description');
        const editProductPrice = document.getElementById('edit-product-price');
        const editProductStock = document.getElementById('edit-product-stock');
        const editProductImageFile = document.getElementById('edit-product-image-file');
        const editProductImageUrl = document.getElementById('edit-product-image-url');
        const editCurrentImagePreview = document.getElementById('edit-current-image-preview');
        const editProductDiscount = document.getElementById('edit-product-discount');
        const editProductOnSale = document.getElementById('edit-product-on-sale');
        const editProductSpinner = document.getElementById('edit-product-spinner');
        const editProductError = document.getElementById('edit-product-error');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editImageUrlChanged = document.getElementById('edit-image-url-changed');
        const editProductCategorySelect = document.getElementById('edit-product-category-select');

        // Елементи фільтрації та сортування
        const categoryFilter = document.getElementById('category-filter');
        const sortFilter = document.getElementById('sort-filter');

        // Елементи адмін-панелі для категорій
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name-input');
        const addCategoryError = document.getElementById('add-category-error');
        const adminCategoriesList = document.getElementById('admin-categories-list');
        const productCategorySelect = document.getElementById('product-category-select'); // Для форми додавання товару

        // Елементи модального вікна редагування категорії
        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryForm = document.getElementById('edit-category-form');
        const editCategoryId = document.getElementById('edit-category-id');
        const editCategoryName = document.getElementById('edit-category-name');
        const cancelEditCategoryBtn = document.getElementById('cancel-edit-category-btn');
        const editCategoryError = document.getElementById('edit-category-error');

        // Елементи модального вікна власного сповіщення (тепер загального)
        const openGeneralNotifyModalBtn = document.getElementById('open-general-notify-modal-btn');
        const customNotifyModal = document.getElementById('custom-notify-modal');
        const customNotifyForm = document.getElementById('custom-notify-form');
        const notifyMessageText = document.getElementById('notify-message-text');
        const notifyImageFile = document.getElementById('notify-image-file');
        const notifyCancelBtn = document.getElementById('notify-cancel-btn');
        const notifySendBtn = document.getElementById('notify-send-btn');
        const notifyError = document.getElementById('notify-error');

        // Елементи для імпорту CSV
        const importCsvForm = document.getElementById('import-csv-form');
        const csvFileInput = document.getElementById('csv-file-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const importCsvSpinner = document.getElementById('import-csv-spinner');
        const importCsvError = document.getElementById('import-csv-error');
        const importCsvSuccess = document.getElementById('import-csv-success');
        const exportCsvSampleBtn = document.getElementById('export-csv-sample-btn'); // Нова кнопка

        // Елементи для списку користувачів
        const adminCustomersList = document.getElementById('admin-customers-list');
        const refreshCustomersBtn = document.getElementById('refresh-customers-btn');

        // NEW: Елементи для управління замовленнями
        const adminNavBtns = document.querySelectorAll('.admin-nav-btn');
        const adminSections = document.querySelectorAll('.admin-section');
        const adminOrdersList = document.getElementById('admin-orders-list');
        const orderStatusFilter = document.getElementById('order-status-filter');
        const refreshOrdersBtn = document.getElementById('refresh-orders-btn');

        // NEW: Елементи для першого відвідування
        const firstVisitDialog = document.getElementById('first-visit-dialog');
        const firstVisitOkBtn = document.getElementById('first-visit-ok-btn');


        // --- УТИЛІТИ (Заміна alert/confirm) ---

        function showAlert(message) {
            dialogConfirmBtn.classList.add('hidden');
            dialogCancelBtn.classList.add('hidden');
            dialogAlertBtn.classList.remove('hidden');
            dialogMessage.textContent = message;
            dialogBox.classList.add('dialog-show');
        }

        function showConfirm(message) {
            return new Promise(resolve => {
                dialogResolve = resolve;
                dialogAlertBtn.classList.add('hidden');
                dialogConfirmBtn.classList.remove('hidden');
                dialogCancelBtn.classList.remove('hidden');
                dialogMessage.textContent = message;
                dialogBox.classList.add('dialog-show');
            });
        }

        // Обробники Діалогу
        dialogAlertBtn.onclick = () => dialogBox.classList.remove('dialog-show');
        dialogConfirmBtn.onclick = () => {
            if (dialogResolve) dialogResolve(true);
            dialogBox.classList.remove('dialog-show');
        };
        dialogCancelBtn.onclick = () => {
            if (dialogResolve) dialogResolve(false);
            dialogBox.classList.remove('dialog-show');
        };

        // Обробники для модального вікна редагування товару
        cancelEditBtn.addEventListener('click', () => {
            editProductModal.classList.remove('dialog-show');
            editProductForm.reset();
            editProductError.classList.add('hidden');
        });

        editProductImageUrl.addEventListener('input', () => {
            editImageUrlChanged.value = 'true';
        });
        editProductImageFile.addEventListener('change', () => {
            if (editProductImageFile.files.length > 0) {
                editProductImageUrl.value = '';
                editImageUrlChanged.value = 'true';
            }
        });

        // --- НАВІГАЦІЯ ---

        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');

            navLinks.forEach(link => {
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active-link');
                } else {
                    link.classList.remove('active-link');
                }
            });

            if (pageId === 'products') {
                fetchProducts();
            } else if (pageId === 'cart') {
                renderCart();
            } else if (pageId === 'admin') {
                checkAdminAuth();
            }
        }

        // Обробник кліку по логотипу
        logoLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '#products'; // Перенаправлення на сторінку товарів
            showPage('products');
        });

        // --- API ТА РЕНДЕРИНГ ТОВАРІВ ---

        async function fetchCategories() {
            try {
                const response = await fetch(API_BASE_URL + '?action=get_categories');
                const data = await response.json();
                if (data.status === 'success') {
                    categories = data.data;
                    categoryFilter.innerHTML = '<option value="">Всі категорії</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        categoryFilter.appendChild(option);
                    });
                } else {
                    console.error('Помилка завантаження категорій:', data.message);
                }
            } catch (error) {
                console.error('Fetch Categories Error:', error);
            }
        }

        async function fetchProducts() {
            productsContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                let url = API_BASE_URL + '?action=get_products';
                const categoryId = categoryFilter.value;
                const sort = sortFilter.value;
                const searchTerm = searchInput.value.trim(); // Отримуємо значення пошуку

                if (categoryId) url += '&category_id=' + encodeURIComponent(categoryId);
                if (sort) url += '&sort=' + encodeURIComponent(sort);
                if (searchTerm) url += '&search=' + encodeURIComponent(searchTerm); // Додаємо параметр пошуку

                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    products = data.data.map(p => ({
                        ...p,
                        in_stock: parseInt(p.in_stock),
                        discount_percentage: parseInt(p.discount_percentage),
                        is_on_sale: Boolean(p.is_on_sale)
                    }));
                    renderProducts();
                    renderCart();
                    
                    // Якщо адмін залогінений - оновити адмін-панель
                    if (isAdminLoggedIn) {
                        renderAdminProducts();
                    }
                } else {
                    throw new Error(data.message || 'Помилка при отриманні даних з API.');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                errorMessage.textContent = `Помилка завантаження даних: ${error.message}. Переконайтеся, що сервер/MySQL запущені, а URL зображень доступні.`;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function renderProducts() {
            productsContainer.innerHTML = '';
            if (products.length === 0) {
                productsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg">Товари не знайдено. Додайте їх через Адмін-панель.</p>';
                return;
            }

            products.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'product-card bg-white rounded-xl shadow-md flex flex-col items-center text-center';

                let imageUrl = '';
                if (product.image_url && product.image_url.startsWith('http')) {
                    imageUrl = product.image_url;
                } else if (product.image_url) {
                    imageUrl = UPLOAD_DIR + product.image_url;
                } else {
                    imageUrl = 'https://placehold.co/192x192/94a3b8/ffffff?text=НЕМАЄ+ФОТО';
                }

                let priceHtml = `<p class="text-3xl font-extrabold text-success-green mb-2">${product.price.toFixed(2)} грн</p>`;
                if (product.is_on_sale && product.discount_percentage > 0) {
                    const discountedPrice = product.price * (1 - product.discount_percentage / 100);
                    priceHtml = `
                        <p class="text-3xl font-extrabold text-success-green mb-2 flex items-center justify-center">
                            <span class="original-price">${product.price.toFixed(2)} грн</span>
                            ${discountedPrice.toFixed(2)} грн
                            <span class="discount-badge">-${product.discount_percentage}%</span>
                        </p>
                    `;
                }

                productElement.innerHTML = `
                    <div class="w-48 h-48 mb-4 overflow-hidden rounded-lg border border-gray-100 shadow-sm">
                        <img
                            src="${imageUrl}"
                            alt="${product.name}"
                            class="w-full h-full object-cover transition duration-300 ease-in-out hover:scale-105"
                            onerror="this.onerror=null; this.src='https://placehold.co/192x192/94a3b8/ffffff?text=НЕМАЄ+ФОТО'; this.style.fontSize='14px';"
                            loading="lazy"
                        >
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">${product.name}</h3>
                    ${priceHtml}
                    <span class="product-availability ${product.in_stock > 0 ? 'in-stock' : 'out-of-stock'}">
                        ${product.in_stock > 0 ? `В наявності (${product.in_stock} шт.)` : 'Немає в наявності'}
                    </span>
                    <button
                        class="primary-btn w-full text-base py-2.5 mt-4 ${product.in_stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                        data-id="${product.id}"
                        ${product.in_stock === 0 ? 'disabled' : ''}
                    >
                        До кошика
                    </button>
                    <div class="product-description-wrapper">
                        ${product.description ? `<p>${product.description}</p>` : ''}
                    </div>
                `;
                productsContainer.appendChild(productElement);
            });

            document.querySelectorAll('.primary-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    if(e.target.dataset.id) {
                         addToCart(e.target.dataset.id);
                    }
                });
            });
        }

        categoryFilter.addEventListener('change', fetchProducts);
        sortFilter.addEventListener('change', fetchProducts);
        searchInput.addEventListener('input', fetchProducts); // Додано обробник для поля пошуку

        // --- ЛОГІКА КОШИКА (LOCAL) ---

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCounter();
        }

        function updateCartCounter() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountElement.textContent = totalItems;

            if (totalItems > 0) {
                cartCountElement.classList.add('active');
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                cartCountElement.classList.remove('active');
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            updateCartTotal();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id == productId);
            if (!product) {
                showAlert("Товар не знайдено.");
                return;
            }
            if (product.in_stock <= 0) {
                showAlert("Цього товару немає в наявності.");
                return;
            }

            const existingItem = cart.find(item => item.id == productId);

            if (existingItem) {
                if (existingItem.quantity < product.in_stock) {
                    existingItem.quantity += 1;
                } else {
                    showAlert(`Ви не можете додати більше ${product.in_stock} шт. товару "${product.name}".`);
                    return;
                }
            } else {
                cart.push({
                    id: productId,
                    quantity: 1
                });
            }

            saveCart();
            renderCart();

            const cartNavItem = document.getElementById('cart-nav-item');
            cartNavItem.classList.add('cart-bump');
            setTimeout(() => {
                cartNavItem.classList.remove('cart-bump');
            }, 300);
        }

        function renderCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            let currentTotal = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-lg p-4 bg-gray-50 rounded-lg">Кошик порожній. Додайте щось із каталогу!</p>';
            }

            cart.forEach(item => {
                const product = products.find(p => p.id == item.id);

                if (!product) {
                    return;
                }

                let itemPrice = product.price;
                if (product.is_on_sale && product.discount_percentage > 0) {
                    itemPrice = product.price * (1 - product.discount_percentage / 100);
                }

                const itemTotal = itemPrice * item.quantity;
                currentTotal += itemTotal;

                let imageUrl = '';
                if (product.image_url && product.image_url.startsWith('http')) {
                    imageUrl = product.image_url;
                } else if (product.image_url) {
                    imageUrl = UPLOAD_DIR + product.image_url;
                } else {
                    imageUrl = 'https://placehold.co/64x64/94a3b8/ffffff?text=X';
                }

                let priceDisplay = `${itemPrice.toFixed(2)} грн`;
                if (product.is_on_sale && product.discount_percentage > 0) {
                    priceDisplay = `<span class="original-price">${product.price.toFixed(2)}</span> ${itemPrice.toFixed(2)} грн (-${product.discount_percentage}%)`;
                }

                const itemElement = document.createElement('div');
                // MOBILE ADAPTATION: Елементи кошика - адаптивні
                itemElement.className = 'cart-item flex flex-col sm:flex-row items-start sm:items-center bg-white p-3 sm:p-4 rounded-xl shadow-sm hover:shadow-md transition duration-200 border border-border-light';
                itemElement.innerHTML = `
                    <div class="flex items-center space-x-3 sm:space-x-4 flex-grow w-full sm:w-auto mb-2 sm:mb-0">
                        <img
                            src="${imageUrl}"
                            alt="${product.name}"
                            class="w-12 h-12 sm:w-16 sm:h-16 object-cover rounded-lg border border-gray-200"
                            onerror="this.onerror=null; this.src='https://placehold.co/64x64/94a3b8/ffffff?text=X';"
                            loading="lazy"
                        >
                        <div class="flex flex-col min-w-0 flex-grow">
                            <div class="text-base sm:text-lg font-bold text-gray-800 truncate">${product.name}</div>
                            <div class="text-xs sm:text-sm text-gray-600">${priceDisplay} / шт</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between sm:justify-end space-x-3 sm:space-x-4 ml-0 sm:ml-auto w-full sm:w-auto">
                        <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                            <button class="quantity-btn minus text-lg sm:text-xl w-7 h-7 sm:w-8 sm:h-8 bg-gray-100 hover:bg-gray-200 transition" data-id="${item.id}">-</button>
                            <span class="px-2 sm:px-3 font-semibold text-sm sm:text-base">${item.quantity}</span>
                            <button class="quantity-btn plus text-lg sm:text-xl w-7 h-7 sm:w-8 sm:h-8 bg-gray-100 hover:bg-gray-200 transition" data-id="${item.id}">+</button>
                        </div>
                        <div class="text-base sm:text-xl font-bold text-header-dark w-20 sm:w-24 text-right">${itemTotal.toFixed(2)} грн</div>
                        <button class="remove-btn text-red-500 hover:text-red-700 transition" data-id="${item.id}" aria-label="Видалити">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });

            saveCart();
            updateCartTotal();

            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const change = e.currentTarget.classList.contains('plus') ? 1 : -1;
                    updateCartQuantity(id, change);
                });
            });
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    removeFromCart(e.currentTarget.dataset.id);
                });
            });
        }

        function updateCartQuantity(productId, change) {
            const item = cart.find(i => i.id == productId);
            if (item) {
                const product = products.find(p => p.id == productId);
                if (change > 0 && item.quantity >= product.in_stock) {
                    showAlert(`Ви не можете додати більше ${product.in_stock} шт. товару "${product.name}".`);
                    return;
                }
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    saveCart();
                    renderCart();
                }
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id != productId);
            saveCart();
            renderCart();
        }

        function updateCartTotal() {
            let total = cart.reduce((sum, item) => {
                const product = products.find(p => p.id == item.id);
                if (!product) return sum;

                let itemPrice = product.price;
                if (product.is_on_sale && product.discount_percentage > 0) {
                    itemPrice = product.price * (1 - product.discount_percentage / 100);
                }
                return sum + (itemPrice * item.quantity);
            }, 0);

            if (needsDeliveryCheckbox.checked) {
                total += DELIVERY_COST;
            }
            cartTotalElement.textContent = total.toFixed(2);
        }

        needsDeliveryCheckbox.addEventListener('change', updateCartTotal);

        // --- ФУНКЦІОНАЛ ОФОРМЛЕННЯ ЗАМОВЛЕННЯ (TELEGRAM BOT API) ---

        customerInfoForm.addEventListener('submit', placeOrder);

        async function placeOrder(e) {
            e.preventDefault();

            if (cart.length === 0) {
                showAlert('Кошик порожній. Додайте товари, щоб оформити замовлення.');
                return;
            }

            const customerName = document.getElementById('customer-name').value.trim();
            const customerTelegram = document.getElementById('customer-telegram').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const customerAddress = document.getElementById('customer-address').value.trim();
            const needsDelivery = needsDeliveryCheckbox.checked;
            let total = parseFloat(cartTotalElement.textContent);

            if (!customerName || !customerPhone || !customerTelegram) {
                showAlert('Будь ласка, заповніть усі обов\'язкові поля: Ваше ім\'я, Номер телефону та Ваш нік у Telegram.');
                return;
            }
            if (needsDelivery && !customerAddress) {
                showAlert('Будь ласка, вкажіть кімнату доставки, якщо обрано доставку.');
                return;
            }

            const confirmed = await showConfirm(`Підтвердьте замовлення на суму ${total.toFixed(2)} грн.`);
            if (!confirmed) return;

            const orderData = {
                action: 'place_order',
                customer: {
                    name: customerName,
                    telegram: customerTelegram,
                    phone: customerPhone,
                    address: customerAddress,
                    needs_delivery: needsDelivery
                },
                items: cart.map(item => {
                    const product = products.find(p => p.id == item.id);
                    let itemPrice = product ? product.price : 0;
                    if (product && product.is_on_sale && product.discount_percentage > 0) {
                        itemPrice = product.price * (1 - product.discount_percentage / 100);
                    }
                    return {
                        id: item.id, // NEW: Add product ID
                        name: product ? product.name : 'Невідомий товар',
                        price: itemPrice,
                        quantity: item.quantity
                    };
                }),
                total_amount: total
            };

            try {
                checkoutBtn.innerHTML = '<div id="api-spinner"></div> Оформлення...';
                checkoutBtn.disabled = true;

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert("✅ Замовлення успішно оформлено! Ми зв'яжемося з вами найближчим часом.");
                    cart = [];
                    saveCart();
                    renderCart();
                    customerInfoForm.reset();
                    showPage('products');
                } else {
                    throw new Error(result.message || 'Помилка при оформленні замовлення.');
                }
            } catch (error) {
                console.error('Place Order Error:', error);
                showAlert(`Помилка оформлення замовлення: ${error.message}. Будь ласка, спробуйте ще раз.`);
            } finally {
                checkoutBtn.innerHTML = 'Оформити замовлення';
                checkoutBtn.disabled = false;
                updateCartCounter();
            }
        }


        // --- ЛОГІКА АДМІНІСТРАТОРА ---

        function checkAdminAuth() {
            const loginArea = document.getElementById('admin-login-area');
            const contentArea = document.getElementById('admin-content');

            // Перевіряємо, чи поточний URL відповідає секретному шляху
            if (window.location.hash === ADMIN_SECRET_PATH) {
                if (localStorage.getItem('adminAuth') === 'true') {
                    isAdminLoggedIn = true;
                    loginArea.classList.add('hidden');
                    contentArea.classList.remove('hidden');
                    
                    // NEW: Show default admin section (e.g., products management)
                    showAdminSection('products-management');
                    
                    fetchAdminCategories(); // Завантажуємо категорії для адмін-панелі
                    fetchProducts(); // Завантажуємо товари (це також викличе renderAdminProducts через isAdminLoggedIn)
                    fetchCustomers(); // Fetch customers when admin logs in
                    fetchOrders(); // NEW: Fetch orders when admin logs in
                } else {
                    isAdminLoggedIn = false;
                    loginArea.classList.remove('hidden');
                    contentArea.classList.add('hidden');
                }
            } else {
                // Якщо URL не відповідає секретному шляху, приховуємо адмін-панель
                loginArea.classList.add('hidden');
                contentArea.classList.add('hidden');
                isAdminLoggedIn = false;
            }
        }

        // NEW: Function to switch admin sections
        function showAdminSection(sectionId) {
            adminSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId + '-section').classList.remove('hidden');

            adminNavBtns.forEach(btn => {
                if (btn.dataset.adminPage === sectionId) {
                    btn.classList.add('active-link'); // Use active-link style for active admin nav button
                } else {
                    btn.classList.remove('active-link');
                }
            });

            // Trigger data fetch for the active section
            if (sectionId === 'products-management') {
                fetchProducts(); // This will also call renderAdminProducts
            } else if (sectionId === 'orders-management') {
                fetchOrders();
            } else if (sectionId === 'users-management') {
                fetchCustomers();
            }
            // No specific fetch for notifications-management as it's just a form
        }

        // NEW: Event listeners for admin navigation buttons
        adminNavBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                showAdminSection(btn.dataset.adminPage);
            });
        });


        document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('login-error');

            errorElement.classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('action', 'admin_login');
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success' && result.authenticated) {
                    localStorage.setItem('adminAuth', 'true');
                    showAlert('Вхід до адмін-панелі успішний!');
                    // ДОДАНО: Завантажуємо товари після успішного входу
                    await fetchProducts();
                    checkAdminAuth(); // Перевіряємо авторизацію ще раз, щоб оновити інтерфейс
                } else {
                    errorElement.textContent = result.message || 'Неправильне ім\'я користувача або пароль.';
                    errorElement.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Admin Login Error:', error);
                errorElement.textContent = 'Помилка входу. Спробуйте ще раз.';
                errorElement.classList.remove('hidden');
            }
        });

        // --- Керування категоріями в адмін-панелі ---
        async function fetchAdminCategories() {
            try {
                const response = await fetch(API_BASE_URL + '?action=get_categories');
                const data = await response.json();
                if (data.status === 'success') {
                    categories = data.data;
                    renderAdminCategories(); // Рендеримо категорії в адмін-панелі
                    updateCategorySelects(); // Оновлюємо випадаючі списки категорій
                } else {
                    console.error('Помилка завантаження категорій для адмін-панелі:', data.message);
                }
            } catch (error) {
                console.error('Fetch Admin Categories Error:', error);
            }
        }

        function renderAdminCategories() {
            adminCategoriesList.innerHTML = '';
            if (categories.length === 0) {
                adminCategoriesList.innerHTML = '<p class="text-gray-500">Категорії відсутні.</p>';
                return;
            }
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md border border-gray-200';
                div.innerHTML = `
                    <span>${cat.name} (ID: ${cat.id})</span>
                    <div class="flex space-x-2">
                        <button class="edit-category-btn primary-btn bg-yellow-500 hover:bg-yellow-600 shadow-yellow-600 text-white px-3 py-1 rounded" data-id="${cat.id}" data-name="${cat.name}">Редагувати</button>
                        <button class="delete-category-btn primary-btn bg-danger-red hover:bg-red-700 shadow-red-700 text-white px-3 py-1 rounded" data-id="${cat.id}" data-name="${cat.name}">Видалити</button>
                    </div>
                `;
                adminCategoriesList.appendChild(div);
            });

            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    editCategoryId.value = btn.dataset.id;
                    editCategoryName.value = btn.dataset.name;
                    editCategoryError.classList.add('hidden');
                    editCategoryModal.classList.add('dialog-show');
                });
            });

            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    const name = btn.dataset.name;
                    const confirmed = await showConfirm(`Ви впевнені, що хочете видалити категорію "${name}"?`);
                    if (!confirmed) return;

                    try {
                        const formData = new FormData();
                        formData.append('action', 'delete_category');
                        formData.append('id', id);

                        const response = await fetch(API_BASE_URL, {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();

                        if (result.status === 'success') {
                            showAlert(`Категорію "${name}" успішно видалено.`);
                            await fetchAdminCategories();
                            await fetchCategories();
                        } else {
                            throw new Error(result.message || 'Помилка видалення категорії.');
                        }
                    } catch (error) {
                        showAlert(`Помилка видалення категорії: ${error.message}`);
                    }
                });
            });
        }

        function updateCategorySelects() {
            // Оновлення для форми додавання товару
            productCategorySelect.innerHTML = '<option value="">Без категорії</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                productCategorySelect.appendChild(option);
            });

            // Оновлення для форми редагування товару
            if (editProductCategorySelect) {
                editProductCategorySelect.innerHTML = '<option value="">Без категорії</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    editProductCategorySelect.appendChild(option);
                });
            }
        }

        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryNameInput.value.trim();
            addCategoryError.classList.add('hidden');

            if (!categoryName) {
                addCategoryError.textContent = 'Будь ласка, введіть назву категорії.';
                addCategoryError.classList.remove('hidden');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('action', 'add_category');
                formData.append('name', categoryName);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert(`Категорію "${categoryName}" успішно додано!`);
                    categoryNameInput.value = '';
                    await fetchAdminCategories();
                    await fetchCategories();
                } else {
                    throw new Error(result.message || 'Помилка додавання категорії.');
                }
            } catch (error) {
                addCategoryError.textContent = `Помилка: ${error.message}`;
                addCategoryError.classList.remove('hidden');
            }
        });

        // Обробка форми редагування категорії
        editCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editCategoryId.value;
            const name = editCategoryName.value.trim();
            editCategoryError.classList.add('hidden');

            if (!name) {
                editCategoryError.textContent = 'Ім\'я категорії не може бути порожнім.';
                editCategoryError.classList.remove('hidden');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('action', 'update_category');
                formData.append('id', id);
                formData.append('name', name);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Категорію успішно оновлено!');
                    editCategoryModal.classList.remove('dialog-show');
                    await fetchAdminCategories();
                    await fetchCategories();
                } else {
                    throw new Error(result.message || 'Помилка оновлення категорії.');
                }
            } catch (error) {
                editCategoryError.textContent = `Помилка: ${error.message}`;
                editCategoryError.classList.remove('hidden');
            }
        });

        cancelEditCategoryBtn.addEventListener('click', () => {
            editCategoryModal.classList.remove('dialog-show');
            editCategoryError.classList.add('hidden');
        });


        document.getElementById('add-product-form').addEventListener('submit', addProduct);

        async function addProduct(e) {
            e.preventDefault();

            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const imageFile = document.getElementById('product-image-file').files[0];
            const imageUrl = document.getElementById('product-image-url').value.trim();
            const in_stock = parseInt(document.getElementById('product-stock').value);
            const discount_percentage = parseInt(document.getElementById('product-discount').value);
            const is_on_sale = document.getElementById('product-on-sale').checked;
            const category_id = productCategorySelect.value || null;
            const errorElement = document.getElementById('add-product-error');

            errorElement.classList.add('hidden');

            if (!name || isNaN(price) || price <= 0 || isNaN(in_stock) || in_stock < 0 || isNaN(discount_percentage) || discount_percentage < 0 || discount_percentage > 100) {
                showAlert('Будь ласка, заповніть усі обов\'язкові поля коректно (назва, ціна > 0, наявність >= 0, знижка 0-100%).');
                return;
            }
            if (!imageFile && !imageUrl) {
                showAlert('Будь ласка, завантажте зображення або вкажіть URL зображення.');
                return;
            }

            addProductSpinner.innerHTML = '<div id="api-spinner"></div> Оформлення...'; // Оновлено текст
            addProductSpinner.style.display = 'inline-block'; // Показати спінер

            try {
                const formData = new FormData();
                formData.append('action', 'add_product');
                formData.append('name', name);
                formData.append('description', description);
                formData.append('price', price);
                formData.append('in_stock', in_stock);
                formData.append('discount_percentage', discount_percentage);
                formData.append('is_on_sale', is_on_sale ? 1 : 0);
                if (category_id) formData.append('category_id', category_id);

                if (imageFile) {
                    formData.append('image_file', imageFile);
                } else if (imageUrl) {
                    formData.append('image_url', imageUrl);
                }

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Товар успішно додано до MySQL!');
                    document.getElementById('add-product-form').reset();
                    await fetchProducts(); // Оновлюємо список товарів
                    if (isAdminLoggedIn) {
                        renderAdminProducts(); // Перерендеримо адмін-панель
                    }
                } else {
                    throw new Error(result.message || 'Помилка сервера при додаванні.');
                }
            } catch (error) {
                console.error('Add Product Error:', error);
                errorElement.textContent = `Помилка додавання: ${error.message}.`;
                errorElement.classList.remove('hidden');
            } finally {
                addProductSpinner.innerHTML = '';
                addProductSpinner.style.display = 'none'; // Приховати спінер
            }
        }

        async function deleteProduct(productId, productName) {
            const confirmed = await showConfirm(`Ви впевнені, що хочете видалити "${productName}"?`);
            if (!confirmed) return;

            try {
                const formData = new FormData();
                formData.append('action', 'delete_product');
                formData.append('id', productId);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert(`Товар "${productName}" успішно видалено з MySQL.`);

                    cart = cart.filter(item => item.id != productId);
                    saveCart();

                    fetchProducts();
                } else {
                    throw new Error(result.message || 'Помилка сервера при видаленні.');
                }
            } catch (error) {
                console.error('Delete Product Error:', error);
                showAlert(`Помилка видалення: ${error.message}`);
            }
        }

        async function updateProductStock(productId, newStock) {
            try {
                const formData = new FormData();
                formData.append('action', 'update_product_stock');
                formData.append('id', productId);
                formData.append('in_stock', newStock);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    fetchProducts();
                } else {
                    throw new Error(result.message || 'Помилка сервера при оновленні наявності.');
                }
            } catch (error) {
                console.error('Update Stock Error:', error);
                showAlert(`Помилка оновлення наявності: ${error.message}`);
            }
        }

        async function notifyCustomers(productId, productName, newStock) {
            const confirmed = await showConfirm(`Сповістити всіх підписників про оновлення наявності товару "${productName}" до ${newStock} шт.?`);
            if (!confirmed) return;

            try {
                const formData = new FormData();
                formData.append('action', 'notify_stock_update');
                formData.append('product_id', productId);
                formData.append('product_name', productName);
                formData.append('new_stock', newStock);
                formData.append('website_url', WEBSITE_BASE_URL); // <--- ДОДАНО: Передаємо URL сайту

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Сповіщення успішно відправлено підписникам!');
                } else {
                    throw new Error(result.message || 'Помилка при відправці сповіщень.');
                }
            } catch (error) {
                console.error('Notify Customers Error:', error);
                showAlert(`Помилка відправки сповіщень: ${error.message}`);
            }
        }

        function renderAdminProducts() {
            adminProductsList.innerHTML = '';
            if (products.length === 0) {
                adminProductsList.innerHTML = '<p class="text-gray-500">Немає товарів для відображення.</p>';
                return;
            }

            products.forEach(product => {
                let imageUrl = '';
                if (product.image_url && product.image_url.startsWith('http')) {
                    imageUrl = product.image_url;
                } else if (product.image_url) {
                    imageUrl = UPLOAD_DIR + product.image_url;
                } else {
                    imageUrl = 'https://placehold.co/48x48/94a3b8/ffffff?text=X';
                }

                let priceDisplay = `${product.price.toFixed(2)} грн`;
                if (product.is_on_sale && product.discount_percentage > 0) {
                    const discountedPrice = product.price * (1 - product.discount_percentage / 100);
                    priceDisplay = `<span class="original-price">${product.price.toFixed(2)}</span> ${discountedPrice.toFixed(2)} грн (-${product.discount_percentage}%)`;
                }

                const categoryName = product.category_id ? (categories.find(c => c.id == product.category_id)?.name || 'Невідома') : 'Без категорії';

                const item = document.createElement('div');
                item.className = 'admin-product-item';
                item.innerHTML = `
                    <img
                        src="${imageUrl}"
                        alt="Preview"
                        class="w-12 h-12 object-cover rounded-md border border-gray-200"
                        onerror="this.onerror=null; this.src='https://placehold.co/48x48/94a3b8/ffffff?text=X';"
                        loading="lazy"
                    >
                    <div class="product-details">
                        <div class="name">${product.name}</div>
                        ${product.description ? `<div class="text-xs text-gray-500 truncate w-32 sm:w-64">${product.description}</div>` : ''}
                        <div class="price">${priceDisplay}</div>
                        <div class="text-xs text-gray-500">Категорія: ${categoryName}</div>
                        <div class="id">ID: ${product.id}</div>
                    </div>
                    <div class="controls">
                        <input type="number" class="product-stock-input" data-id="${product.id}" value="${product.in_stock}" min="0">
                        <button data-id="${product.id}" data-name="${product.name}" data-stock="${product.in_stock}" class="notify-btn">
                            Сповістити
                        </button>
                        <button data-id="${product.id}" class="edit-btn">
                            Редагувати
                        </button>
                        <button data-id="${product.id}" data-name="${product.name}" class="delete-admin-btn">
                            Видалити
                        </button>
                    </div>
                `;
                adminProductsList.appendChild(item);
            });

            document.querySelectorAll('.delete-admin-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const name = e.currentTarget.dataset.name;
                    deleteProduct(id, name);
                });
            });

            document.querySelectorAll('.product-stock-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const newStock = parseInt(e.currentTarget.value);
                    if (!isNaN(newStock) && newStock >= 0) {
                        updateProductStock(id, newStock);
                        const notifyButton = e.currentTarget.closest('.admin-product-item').querySelector('.notify-btn');
                        if (notifyButton) {
                            notifyButton.dataset.stock = newStock;
                        }
                    } else {
                        showAlert('Будь ласка, введіть коректне число для наявності (>= 0).');
                        e.currentTarget.value = products.find(p => p.id == id).in_stock;
                    }
                });
            });

            document.querySelectorAll('.notify-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const name = e.currentTarget.dataset.name;
                    const stock = e.currentTarget.dataset.stock;
                    notifyCustomers(id, name, stock);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    editProduct(id);
                });
            });
        }

        // --- ФУНКЦІОНАЛ РЕДАГУВАННЯ ТОВАРУ ---
        async function editProduct(productId) {
            const product = products.find(p => p.id == productId);
            if (!product) {
                showAlert('Товар не знайдено для редагування.');
                return;
            }

            editProductId.value = product.id;
            editProductName.value = product.name;
            editProductDescription.value = product.description || '';
            editProductPrice.value = product.price.toFixed(2);
            editProductStock.value = product.in_stock;
            editProductDiscount.value = product.discount_percentage;
            editProductOnSale.checked = product.is_on_sale;
            editProductCategorySelect.value = product.category_id || '';

            let currentImageUrl = '';
            if (product.image_url && product.image_url.startsWith('http')) {
                currentImageUrl = product.image_url;
            } else if (product.image_url) {
                currentImageUrl = UPLOAD_DIR + product.image_url;
            } else {
                currentImageUrl = 'https://placehold.co/96x96/94a3b8/ffffff?text=НЕМАЄ+ФОТО';
            }
            editCurrentImagePreview.src = currentImageUrl;
            editProductImageUrl.value = product.image_url && product.image_url.startsWith('http') ? product.image_url : '';

            editProductImageFile.value = '';
            editImageUrlChanged.value = 'false';

            editProductError.classList.add('hidden');
            editProductModal.classList.add('dialog-show');
        }

        editProductForm.addEventListener('submit', saveEditedProduct);

        async function saveEditedProduct(e) {
            e.preventDefault();

            const id = editProductId.value;
            const name = editProductName.value;
            const description = editProductDescription.value;
            const price = parseFloat(editProductPrice.value);
            const in_stock = parseInt(editProductStock.value);
            const discount_percentage = parseInt(editProductDiscount.value);
            const is_on_sale = editProductOnSale.checked;
            const category_id = editProductCategorySelect.value || null;
            const imageFile = editProductImageFile.files[0];
            const imageUrl = editProductImageUrl.value.trim();
            const imageUrlChanged = editImageUrlChanged.value;

            editProductError.classList.add('hidden');

            if (!name || isNaN(price) || price <= 0 || isNaN(in_stock) || in_stock < 0 || isNaN(discount_percentage) || discount_percentage < 0 || discount_percentage > 100) {
                editProductError.textContent = 'Будь ласка, заповніть усі обов\'язкові поля коректно (назва, ціна > 0, наявність >= 0, знижка 0-100%).';
                editProductError.classList.remove('hidden');
                return;
            }

            editProductSpinner.innerHTML = '<div id="api-spinner"></div> Збереження...'; // Оновлено текст
            editProductSpinner.style.display = 'inline-block'; // Показати спінер

            try {
                const formData = new FormData();
                formData.append('action', 'update_product');
                formData.append('id', id);
                formData.append('name', name);
                formData.append('description', description);
                formData.append('price', price);
                formData.append('in_stock', in_stock);
                formData.append('discount_percentage', discount_percentage);
                formData.append('is_on_sale', is_on_sale ? 1 : 0);
                if (category_id) formData.append('category_id', category_id);
                formData.append('image_url_changed', imageUrlChanged);

                if (imageFile) {
                    formData.append('image_file', imageFile);
                } else {
                    formData.append('image_url', imageUrl);
                }

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Товар успішно оновлено!');
                    editProductModal.classList.remove('dialog-show');
                    fetchProducts();
                } else {
                    throw new Error(result.message || 'Помилка сервера при оновленні.');
                }
            } catch (error) {
                console.error('Update Product Error:', error);
                editProductError.textContent = `Помилка оновлення: ${error.message}.`;
                editProductError.classList.remove('hidden');
            } finally {
                editProductSpinner.innerHTML = '';
                editProductSpinner.style.display = 'none'; // Приховати спінер
            }
        }

        // --- Функціонал власного ЗАГАЛЬНОГО сповіщення ---
        openGeneralNotifyModalBtn.addEventListener('click', () => {
            notifyMessageText.value = '';
            notifyImageFile.value = '';
            notifyError.classList.add('hidden');
            customNotifyModal.classList.add('dialog-show');
        });

        notifyCancelBtn.addEventListener('click', () => {
            customNotifyModal.classList.remove('dialog-show');
            notifyError.classList.add('hidden');
        });

        customNotifyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            notifyError.classList.add('hidden');

            const messageText = notifyMessageText.value.trim();
            if (!messageText) {
                notifyError.textContent = 'Будь ласка, введіть текст повідомлення.';
                notifyError.classList.remove('hidden');
                return;
            }

            notifySendBtn.disabled = true;
            notifySendBtn.innerHTML = '<div id="api-spinner"></div> Відправка...';
            notifySendBtn.querySelector('#api-spinner').style.display = 'inline-block'; // Показати спінер

            try {
                const formData = new FormData();
                formData.append('action', 'send_custom_notification');
                formData.append('message_text', messageText);
                if (notifyImageFile.files.length > 0) {
                    formData.append('image_file', notifyImageFile.files[0]);
                }

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Повідомлення успішно відправлено підписникам!');
                    customNotifyModal.classList.remove('dialog-show');
                } else {
                    throw new Error(result.message || 'Помилка при відправці повідомлення.');
                }
            } catch (error) {
                console.error('Custom Notify Error:', error);
                notifyError.textContent = `Помилка: ${error.message}`;
                notifyError.classList.remove('hidden');
            } finally {
                notifySendBtn.disabled = false;
                notifySendBtn.innerHTML = 'Відправити';
                notifySendBtn.querySelector('#api-spinner').style.display = 'none'; // Приховати спінер
            }
        });

        // --- Функціонал імпорту CSV ---
        importCsvForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            importCsvError.classList.add('hidden');
            importCsvSuccess.classList.add('hidden');

            const file = csvFileInput.files[0];
            if (!file) {
                importCsvError.textContent = 'Будь ласка, виберіть CSV-файл.';
                importCsvError.classList.remove('hidden');
                return;
            }

            const confirmed = await showConfirm(`Ви впевнені, що хочете імпортувати товари з файлу "${file.name}"? Існуючі товари з такими ж назвами будуть оновлені.`);
            if (!confirmed) return;

            importCsvBtn.disabled = true;
            importCsvSpinner.innerHTML = '<div id="api-spinner"></div> Імпорт...';
            importCsvSpinner.style.display = 'inline-block'; // Показати спінер

            try {
                const formData = new FormData();
                formData.append('action', 'import_products_csv');
                formData.append('csv_file', file);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                
                // Спробуємо отримати текстову відповідь, якщо JSON парсинг не вдається
                const responseText = await response.text();
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('JSON Parse Error:', jsonError);
                    console.error('Server Response Text:', responseText);
                    throw new Error(`Сервер повернув невалідний JSON. Відповідь: ${responseText.substring(0, 200)}...`);
                }


                if (result.status === 'success') {
                    importCsvSuccess.textContent = `Імпорт успішно завершено! Додано: ${result.added_count}, Оновлено: ${result.updated_count}.`;
                    importCsvSuccess.classList.remove('hidden');
                    csvFileInput.value = ''; // Очистити поле файлу
                    await fetchProducts(); // Оновити список товарів
                    if (isAdminLoggedIn) {
                        renderAdminProducts(); // Перерендеримо адмін-панель
                    }
                } else if (result.status === 'warning') {
                    importCsvError.textContent = `Імпорт завершено з попередженнями: ${result.message}`;
                    importCsvError.classList.remove('hidden');
                    csvFileInput.value = '';
                    await fetchProducts();
                    if (isAdminLoggedIn) {
                        renderAdminProducts(); // Перерендеримо адмін-панель
                    }
                }
                else {
                    throw new Error(result.message || 'Помилка імпорту CSV.');
                }
            } catch (error) {
                console.error('CSV Import Error:', error);
                importCsvError.textContent = `Помилка імпорту: ${error.message}`;
                importCsvError.classList.remove('hidden');
            } finally {
                importCsvBtn.disabled = false;
                importCsvSpinner.innerHTML = '';
                importCsvSpinner.style.display = 'none'; // Приховати спінер
            }
        });

        // Функціонал експорту зразка CSV
        exportCsvSampleBtn.addEventListener('click', () => {
            const headers = "Назва продукту,ціна за штуку,кількість,акція якшо є (1/0),відсоток знижки,опис,URL зображення";
            const sampleData = [
                "Приклад товару 1,120.00,10,1,15,Короткий опис товару 1,https://example.com/image1.jpg",
                "Приклад товару 2,250.50,5,0,0,Короткий опис товару 2,https://example.com/image2.png",
                "Приклад товару 3,50.00,20,1,10,Короткий опис товару 3,https://example.com/image3.webp"
            ];
            const csvContent = headers + "\n" + sampleData.join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "sample_products.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            showAlert('Зразок CSV-файлу успішно завантажено!');
        });

        // --- Функціонал списку користувачів ---
        async function fetchCustomers() {
            adminCustomersList.innerHTML = '<p class="text-gray-500">Завантаження користувачів...</p>';
            try {
                const response = await fetch(API_BASE_URL + '?action=get_telegram_users');
                const data = await response.json();
                if (data.status === 'success') {
                    customers = data.data;
                    renderCustomers();
                } else {
                    console.error('Помилка завантаження користувачів:', data.message);
                    adminCustomersList.innerHTML = `<p class="text-red-500">Помилка завантаження користувачів: ${data.message}</p>`;
                }
            } catch (error) {
                console.error('Fetch Customers Error:', error);
                adminCustomersList.innerHTML = `<p class="text-red-500">Помилка завантаження користувачів: ${error.message}</p>`;
            }
        }

        function renderCustomers() {
            adminCustomersList.innerHTML = '';
            if (customers.length === 0) {
                adminCustomersList.innerHTML = '<p class="text-gray-500">Немає зареєстрованих користувачів Telegram.</p>';
                return;
            }

            customers.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'customer-item';
                item.innerHTML = `
                    <div class="customer-details">
                        <div class="username">@${customer.telegram_username}</div>
                        <div class="chat-id">Chat ID: <code>${customer.telegram_chat_id}</code></div>
                    </div>
                `;
                adminCustomersList.appendChild(item);
            });
        }

        refreshCustomersBtn.addEventListener('click', fetchCustomers);

        // NEW: Функціонал управління замовленнями
        async function fetchOrders() {
            adminOrdersList.innerHTML = '<p class="text-gray-500">Завантаження замовлень...</p>';
            try {
                let url = API_BASE_URL + '?action=get_orders';
                const statusFilter = orderStatusFilter.value;
                if (statusFilter) {
                    url += '&status=' + encodeURIComponent(statusFilter);
                }

                const response = await fetch(url);
                const data = await response.json();
                if (data.status === 'success') {
                    orders = data.data;
                    renderAdminOrdersList();
                } else {
                    console.error('Помилка завантаження замовлень:', data.message);
                    adminOrdersList.innerHTML = `<p class="text-red-500">Помилка завантаження замовлень: ${data.message}</p>`;
                }
            } catch (error) {
                console.error('Fetch Orders Error:', error);
                adminOrdersList.innerHTML = `<p class="text-red-500">Помилка завантаження замовлень: ${error.message}</p>`;
            }
        }

        function renderAdminOrdersList() {
            adminOrdersList.innerHTML = '';
            if (orders.length === 0) {
                adminOrdersList.innerHTML = '<p class="text-gray-500">Немає замовлень для відображення.</p>';
                return;
            }

            orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                orderElement.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">Замовлення №${order.id}</span>
                        <span class="order-status ${order.status}">${order.status === 'New' ? 'Нове' : (order.status === 'Confirmed' ? 'Підтверджено' : 'Скасовано')}</span>
                    </div>
                    <div class="order-details">
                        <p><strong>Покупець:</strong> ${order.customer_name} (@${order.customer_telegram})</p>
                        <p><strong>Телефон:</strong> ${order.customer_phone}</p>
                        <p><strong>Доставка:</strong> ${order.needs_delivery ? `Так, кімната ${order.customer_address}` : 'Ні'}</p>
                        <p><strong>Сума:</strong> ${order.total_amount.toFixed(2)} грн</p>
                        <p><strong>Дата:</strong> ${new Date(order.created_at).toLocaleString('uk-UA')}</p>
                    </div>
                    <div class="order-items-summary">
                        <strong>Товари:</strong> ${order.items_summary.replace(/;/g, '<br>—')}
                    </div>
                    <div class="order-actions">
                        ${order.status === 'New' ? `
                            <button class="primary-btn bg-success-green hover:bg-green-600 shadow-green-700 confirm-order-btn" data-id="${order.id}">Підтвердити</button>
                            <button class="primary-btn bg-danger-red hover:bg-red-600 shadow-red-700 cancel-order-btn" data-id="${order.id}">Скасувати</button>
                        ` : (order.status === 'Confirmed' ? `
                            <button class="primary-btn bg-danger-red hover:bg-red-600 shadow-red-700 cancel-order-btn" data-id="${order.id}">Скасувати</button>
                        ` : '')}
                    </div>
                `;
                adminOrdersList.appendChild(orderElement);
            });

            document.querySelectorAll('.confirm-order-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const orderId = e.currentTarget.dataset.id;
                    const confirmed = await showConfirm(`Ви впевнені, що хочете підтвердити замовлення №${orderId}?`);
                    if (confirmed) {
                        updateOrderStatus(orderId, 'Confirmed');
                    }
                });
            });

            document.querySelectorAll('.cancel-order-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const orderId = e.currentTarget.dataset.id;
                    const confirmed = await showConfirm(`Ви впевнені, що хочете скасувати замовлення №${orderId}? Товари будуть повернені на склад.`);
                    if (confirmed) {
                        updateOrderStatus(orderId, 'Cancelled');
                    }
                });
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const formData = new FormData();
                formData.append('action', 'update_order_status');
                formData.append('order_id', orderId);
                formData.append('status', newStatus);

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showAlert(`Статус замовлення №${orderId} успішно оновлено на "${newStatus}".`);
                    fetchOrders(); // Оновити список замовлень
                    fetchProducts(); // Оновити список товарів, якщо були зміни наявності
                } else {
                    throw new Error(result.message || 'Помилка оновлення статусу замовлення.');
                }
            } catch (error) {
                console.error('Update Order Status Error:', error);
                showAlert(`Помилка оновлення статусу замовлення: ${error.message}`);
            }
        }

        orderStatusFilter.addEventListener('change', fetchOrders);
        refreshOrdersBtn.addEventListener('click', fetchOrders);

        // NEW: Функціонал для першого відвідування
        function showFirstVisitMessage() {
            if (!localStorage.getItem('firstVisitDone')) {
                firstVisitDialog.classList.add('dialog-show');
            }
        }

        firstVisitOkBtn.addEventListener('click', () => {
            firstVisitDialog.classList.remove('dialog-show');
            localStorage.setItem('firstVisitDone', 'true');
        });


        // --- ІНІЦІАЛІЗАЦІЯ ---

        async function init() {
            // Обробник для зміни хешу URL
            window.addEventListener('hashchange', () => {
                const currentHash = window.location.hash;
                if (currentHash === ADMIN_SECRET_PATH) {
                    showPage('admin');
                } else if (currentHash === '#cart') {
                    showPage('cart');
                } else {
                    showPage('products');
                }
            });

            // Ініціалізація сторінки при завантаженні
            const initialHash = window.location.hash;
            if (initialHash === ADMIN_SECRET_PATH) {
                showPage('admin');
            } else if (initialHash === '#cart') {
                showPage('cart');
            } else {
                showPage('products');
            }

            await fetchCategories(); // Завантажуємо категорії для фільтрації
            await fetchProducts(); // Завантажуємо товари
            showFirstVisitMessage(); // Показати повідомлення про перше відвідування
        }

        init();
    </script>
</body>

</html>
